<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Checkout<span>Shop</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page">Checkout</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->


    

    <div class="page-content">
        <div class="checkout">
            <div class="container">
                
                
                <div class="checkout-discount">
                    
                    <form action="#">
                        <input type="text" class="form-control" required id="checkout-discount-input">
                        <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to
                                enter your code</span></label>
                    </form>
                </div><!-- End .checkout-discount -->

                <div  class="card ">
                    
                    <% address?.address?.forEach((addresses,index)=>{ %> 
                    <div class="card-header pt-3" id="heading-3">
                        <p style="font-size:17px ;"  class="card-title  ">
                           <input   onclick="display('<%=addresses._id %>')" name="address" id=" <%= index+1 %>" value="addrress" type="radio" class="collapsed " role="button" data-toggle="collapse"
                                href="#collapse-3" aria-expanded="false" aria-controls="collapse-<%= index+1 %>">
                                 <%= addresses.firstname %> <%= addresses.lastname %> 
                        </input>
                    </p>
                    </div><!-- End .card-header -->
                    <div id="collapse-3" class="collapse" aria-labelledby="heading-3"
                        data-parent="#accordion-payment">
                        <div class="card-body">
                        
                            <strong>address <%= index+1 %>  </strong> <br><%=addresses.street %> <br> <%= addresses.city%> <br><%=addresses.country%> <br> <%=addresses.state  %> 
                            <br><%= addresses.pincode  %> <br> <%= addresses.phone  %> <br> <%= addresses.email  %>   
                        </div><!-- End .card-body -->
                    </div><!-- End .collapse -->
                    <% }) %> 
                    <a class="m-3" href="/checkout">
                    <button  class="btn btn-primary col-md-12">Add Address</button>
                </a>
                </div><!-- End .card -->

                
                <form action="#">
                    <div class="row">
                        <div class="col-lg-9">
                            <h2 class="checkout-title">Billing Details</h2><!-- End .checkout-title -->
                            <div class="row">

                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between">

                                        <label>First Name *</label>
                                        <p class="text-danger"></p>
                                    </div>
                                    <input id="firstname" name="firstname" type="text" class="form-control" required>


                                </div> <!-- End row -->


                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between">
                                        <label>Last Name *</label>
                                        <p class="text-danger"></p>
                                    </div>
                                    <input id="lastname" name="lastname" type="text" class="form-control" required>
                                </div><!-- End .col-sm-6 -->

                            </div><!-- End .row -->


                            <div class="col-sm-12">
                                <div class="d-flex justify-content-between">

                                    <label>Country *</label>
                                    <p  class="text-danger"></p>
                                </div>
                                <input name="country" id="country" type="text" class="form-control" required>
                            </div>

                            <div>
                                <div class="d-flex justify-content-between">
                                    <label name="streetaddress" id="streetaddress">Street address *</label>
                                    <p id="err"  class="text-danger"></p>
                                </div>
                                <input name="streetaddress" id="streetadress" type="text" class="form-control"
                                    placeholder="House number and Street name" required>
                            </div>

                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between">
                                        <label>Town / City *</label>
                                        <p id="err" class="text-danger" ></p>
                                    </div>
                                    <input id="city" name="city" type="text" class="form-control" required>
                                </div><!-- End .col-sm-6 -->

                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between">

                                        <label>State / County *</label>
                                        <p id="err" class="text-danger"></p>
                                    </div>
                                    <input id="state" name="state" type="text" class="form-control" required>
                                </div><!-- End .col-sm-6 -->
                            </div><!-- End .row -->

                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between">
                                        <label>Pincode *</label>
                                        <p id="err" class="text-danger"></p>
                                    </div>
                                    <input id="pincode" name="pincode" type="text" class="form-control" required>
                                </div><!-- End .col-sm-6 -->

                                <div class="col-sm-6">
                                    <div class="d-flex justify-content-between">
                                        <label>Phone *</label>
                                        <p id="err" class="text-danger"></p>
                                    </div>
                                    <input id="phone" name="phone" type="tel" class="form-control" required>
                                </div><!-- End .col-sm-6 -->
                            </div><!-- End .row -->

                            <div>
                                <div class="d-flex justify-content-between">
                                    <label>Email address *</label>
                                    <p id="err" class="text-danger"></p>
                                </div>
                                <input id="email" name="email" type="email" class="form-control" required>
                            </div>

                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="checkout-create-acc">
                                <label class="custom-control-label" for="checkout-create-acc">Create an account?</label>
                            </div><!-- End .custom-checkbox -->

                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="checkout-diff-address">
                                <label class="custom-control-label" for="checkout-diff-address">Ship to a different
                                    address?</label>
                            </div><!-- End .custom-checkbox -->

                            <label>Order notes (optional)</label>
                            <textarea class="form-control" cols="30" rows="4"
                                placeholder="Notes about your order, e.g. special notes for delivery"></textarea>
                        </div><!-- End .col-lg-9 -->
                        <aside class="col-lg-3">
                            <div class="summary">
                                <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

                                <table class="table table-summary">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        
                                        
                                        <% cartproducts.forEach((cartproducts)=>{%> 
                                        <tr>
                                            <td ><%= cartproducts.product?.name%>   <br> Qty:<%= cartproducts.quantity  %>  </td>
                                            
                                            <td ><%= cartproducts.product?.price* cartproducts.quantity  %></td>
                                         
                                            
                                            </tr>

                                            <% }) %> 
                                        <tr class="summary-subtotal">
                                            <td>Subtotal:</td>
                                            <td><%= totalamount %> </td>
                                        </tr><!-- End .summary-subtotal -->
                                        <tr>
                                            <td>Shipping:</td>
                                            <td>Free shipping</td>
                                        </tr>
                                        <tr class="summary-total">
                                            <td>Total:</td>
                                            <td><%= totalamount %> </td>
                                        </tr><!-- End .summary-total -->
                                     
                                    </tbody>
                                </table><!-- End .table table-summary -->

                                <div class="accordion-summary" id="accordion-payment">
                                    <div class="card">
                                        <div class="card-header" id="heading-1">
                                            <h2 class="card-title">
                                                <a role="button" data-toggle="collapse" href="#collapse-1"
                                                    aria-expanded="true" aria-controls="collapse-1">
                                                    Direct bank transfer
                                                </a>
                                            </h2>
                                        </div><!-- End .card-header -->
                                        <div id="collapse-1" class="collapse show" aria-labelledby="heading-1"
                                            data-parent="#accordion-payment">
                                            <div class="card-body">
                                                Make your payment directly into our bank account. Please use your Order
                                                ID as the payment reference. Your order will not be shipped until the
                                                funds have cleared in our account.
                                            </div><!-- End .card-body -->
                                        </div><!-- End .collapse -->
                                    </div><!-- End .card -->

                                    <div class="card">
                                        <div class="card-header" id="heading-2">
                                            <h2 class="card-title">
                                                <a class="collapsed" role="button" data-toggle="collapse"
                                                    href="#collapse-2" aria-expanded="false" aria-controls="collapse-2">
                                                    Check payments
                                                </a>
                                            </h2>
                                        </div><!-- End .card-header -->
                                        <div id="collapse-2" class="collapse" aria-labelledby="heading-2"
                                            data-parent="#accordion-payment">
                                            <div class="card-body">
                                                Ipsum dolor sit amet, consectetuer adipiscing elit. Donec odio. Quisque
                                                volutpat mattis eros. Nullam malesuada erat ut turpis.
                                            </div><!-- End .card-body -->
                                        </div><!-- End .collapse -->
                                    </div><!-- End .card -->

                                    <div class="card">
                                        <div class="card-header" id="heading-3">
                                            <h2 class="card-title">
                                               <input id="cash" value="cash" type="radio" class="collapsed" role="button" data-toggle="collapse"
                                                    href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
                                                    Cash on delivery
                                            </input>
                                            </h2>
                                        </div><!-- End .card-header -->
                                        <div id="collapse-3" class="collapse" aria-labelledby="heading-3"
                                            data-parent="#accordion-payment">
                                            <div class="card-body">Quisque volutpat mattis eros. Lorem ipsum dolor sit
                                                amet, consectetuer adipiscing elit. Donec odio. Quisque volutpat mattis
                                                eros.
                                            </div><!-- End .card-body -->
                                        </div><!-- End .collapse -->
                                    </div><!-- End .card -->

                                    <div class="card">
                                        <div class="card-header" id="heading-4">
                                            <h2 class="card-title">
                                                <a class="collapsed" role="button" data-toggle="collapse"
                                                    href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
                                                    PayPal <small class="float-right paypal-link">What is
                                                        PayPal?</small>
                                                </a>
                                            </h2>
                                        </div><!-- End .card-header -->
                                        <div id="collapse-4" class="collapse" aria-labelledby="heading-4"
                                            data-parent="#accordion-payment">
                                            <div class="card-body">
                                                Nullam malesuada erat ut turpis. Suspendisse urna nibh, viverra non,
                                                semper suscipit, posuere a, pede. Donec nec justo eget felis facilisis
                                                fermentum.
                                            </div><!-- End .card-body -->
                                        </div><!-- End .collapse -->
                                    </div><!-- End .card -->

                                    <div class="card">
                                        <div class="card-header" id="heading-5">
                                            <h2 class="card-title">
                                                <a class="collapsed" role="button" data-toggle="collapse"
                                                    href="#collapse-5" aria-expanded="false" aria-controls="collapse-5">
                                                    Credit Card (Stripe)
                                                    <img src="assets/images/payments-summary.png" alt="payments cards">
                                                </a>
                                            </h2>
                                        </div><!-- End .card-header -->
                                        <div id="collapse-5" class="collapse" aria-labelledby="heading-5"
                                            data-parent="#accordion-payment">
                                            <div class="card-body"> Donec nec justo eget felis facilisis fermentum.Lorem
                                                ipsum dolor sit amet, consectetuer adipiscing elit. Donec odio. Quisque
                                                volutpat mattis eros. Lorem ipsum dolor sit ame.
                                            </div><!-- End .card-body -->
                                        </div><!-- End .collapse -->
                                    </div><!-- End .card -->
                                </div><!-- End .accordion -->

                                <button onclick="proceedCheckout()" type="button"
                                    class="btn btn-outline-primary-2 btn-order btn-block">
                                    <span class="btn-text">Place Order</span>
                                    <span class="btn-hover-text">Proceed to Checkout</span>
                                </button>
                            </div><!-- End .summary -->
                        </aside><!-- End .col-lg-3 -->
                    </div><!-- End .row -->
                </form>
            </div><!-- End .container -->
        </div><!-- End .checkout -->
    </div><!-- End .page-content -->
</main><!-- End .main -->


<script>

    function proceedCheckout() {
        const firstname = document.getElementById('firstname')
        const firstValue = firstname.value?.trim()
        const firstErr = firstname.parentElement.querySelector('p')
        firstErr.innerText = ""


        const lastname = document.getElementById('lastname')
        const lastvalue = lastname.value?.trim()
        const lastErr = lastname.parentElement.querySelector('p')
        lastErr.innerText = ""

        const country = document.getElementById('country')
        const countryvalue = country.value?.trim()
        const countryErr = country.parentElement.querySelector('p')
        countryErr.innerText = ""

        const streetadress = document.getElementById('streetadress')
        const streetadressvalue = streetadress.value?.trim()
        const streetadressErr = streetadress.parentElement.querySelector('p')
        streetadressErr.innerText = ""

        const city = document.getElementById('city')
        const cityvalue = city.value?.trim()
        const cityErr = city.parentElement.querySelector('p')
        cityErr.innerText = ""


        const state = document.getElementById('state')
        const statevalue = state.value?.trim()
        const stateErr = state.parentElement.querySelector('p')
        stateErr.innerText = ""

        const pincode = document.getElementById('pincode')
        const pincodevalue = pincode.value?.trim()
        const pincodeErr = pincode.parentElement.querySelector('p')
        pincodeErr.innerText = ""


        const phone = document.getElementById('phone')
        const phonevalue = phone.value?.trim()
        const phoneErr = phone.parentElement.querySelector('p')
        phoneErr.innerText = ""

        const email = document.getElementById('email')
        const emailvalue = email.value?.trim()
        const emailErr = email.parentElement.querySelector('p')
        emailErr.innerText = ""

        let flag = 1

        if (firstValue == "") {
            firstErr.innerText = 'this field is required'
            flag=2
        }
        else if( firstValue.length<3){
            firstErr.innerText = 'Please enter proper name'
            flag=2

        }
         
        if (lastvalue == "") {
            lastErr.innerText = 'this field is required'
            flag=2
        }
        else if( lastvalue.length<3){
            lastErr.innerText = 'Please enter proper name'
            flag=2

        }

        if(countryvalue==""){
            countryErr.innerText="This field is required"
            flag=2
        }
        if(streetadressvalue==""){
            streetadressErr.innerText="this field is required"
            flag=2
        }
        else if(streetadressvalue<7){
            streetadressErr.innerText="enter a valid address"
            flag=2
        }
      
        if(cityvalue==""){
            cityErr.innerText="this field is required"
            flag=2
        }

        if(statevalue==""){
            stateErr.innerText="this field is required"
            flag=2
        }

       
        if(pincodevalue==""){
            pincodeErr.innerText="this field is required"
        }
        else if(!pincodevalue.match(/^[0-9]{6}$/)){
            pincodeErr.innerText="enter proper pincode"
        }  
        
        if(phonevalue==""){
            phoneErr.innerText="This field is required"
            flag=2
        }
        else if(!phonevalue.match(/^[0-9]{10}$/)){
            phoneErr.innerText="enter proper mobile number"
            flag=2
        }

       if(emailvalue==""){
        emailErr.innerText="this field is required"
        flag=2
       } 
       else if(!emailvalue.match(
        /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                
       )){
        emailErr.innerText="enter a valid email"
        flag=2
       }
       
       let paymentMethod=document.getElementById('cash').value

        if(flag==1){
             submit(
                firstValue,
                lastvalue,
                countryvalue,
                streetadressvalue,
                cityvalue,
                statevalue,
                pincodevalue,
                phonevalue,
                emailvalue,
                paymentMethod,
            )
        }
function submit(
                firstValue,
                lastvalue,
                countryvalue,
                streetadressvalue,
                cityvalue,
                statevalue,
                pincodevalue,
                phonevalue,
                emailvalue,
                paymentMethod
){
    $.ajax({
    url:'/checkout',
    data:{
        firstname:firstValue,
        lastname:lastvalue,
        country:countryvalue,
        street:streetadressvalue,
        city:cityvalue,
        state:statevalue,
        pincode :pincodevalue,
        phone:phonevalue,
        email:emailvalue,
        paymentMethod:paymentMethod
    },
    method:'post',
    success:(response)=>{
        if(response){
            console.log(response);
            window.location.href="/success"
        }
        
    }

})
}

     
    }

    function display(addressId){
        
         
        $.ajax({
            url:'/filladdres/'+addressId,
            method:'get',
            success:(response)=>{
                console.log(response)
                document.getElementById('firstname').value=response.firstname
                document.getElementById('lastname').value=response.lastname
                document.getElementById('country').value=response.country
                document.getElementById('streetadress').value=response.streetadress
                document.getElementById('city').value=response.city
                document.getElementById('state').value=response.state
                document.getElementById('pincode').value=response.pincode
                document.getElementById('phone').value=response.phone
                document.getElementById('email').value=response.email


            }
        })
    }

</script>